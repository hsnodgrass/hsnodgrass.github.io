<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Automatic TLS with Let’s Encrypt and HAProxy" /><meta name="author" content="Heston Snodgrass" /><meta property="og:locale" content="en_US" /><meta name="description" content="I recently moved from the excellent Caddy to HAProxy for my homelab’s reverse-proxy. This change was due to some expanded functionatlity I wanted that Caddy couldn’t provide as part of a larger homelab reorginization. I may get around to writing about that someday, but today I wanted to write about the best feature of Caddy and how I got it working with HAProxy: automatic TLS via Let’s Encrypt. This walkthrough will get you TLS terminated at HAProxy with a Let’s Encrypt certificate, and we’ll even automate it so the certificate gets automatically renewed." /><meta property="og:description" content="I recently moved from the excellent Caddy to HAProxy for my homelab’s reverse-proxy. This change was due to some expanded functionatlity I wanted that Caddy couldn’t provide as part of a larger homelab reorginization. I may get around to writing about that someday, but today I wanted to write about the best feature of Caddy and how I got it working with HAProxy: automatic TLS via Let’s Encrypt. This walkthrough will get you TLS terminated at HAProxy with a Let’s Encrypt certificate, and we’ll even automate it so the certificate gets automatically renewed." /><link rel="canonical" href="https://hsnodgrass.com/posts/use-letsencrypt-with-haproxy/" /><meta property="og:url" content="https://hsnodgrass.com/posts/use-letsencrypt-with-haproxy/" /><meta property="og:site_name" content="Heston Snodgrass" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-01T16:45:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Automatic TLS with Let’s Encrypt and HAProxy" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Heston Snodgrass" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"I recently moved from the excellent Caddy to HAProxy for my homelab’s reverse-proxy. This change was due to some expanded functionatlity I wanted that Caddy couldn’t provide as part of a larger homelab reorginization. I may get around to writing about that someday, but today I wanted to write about the best feature of Caddy and how I got it working with HAProxy: automatic TLS via Let’s Encrypt. This walkthrough will get you TLS terminated at HAProxy with a Let’s Encrypt certificate, and we’ll even automate it so the certificate gets automatically renewed.","url":"https://hsnodgrass.com/posts/use-letsencrypt-with-haproxy/","@type":"BlogPosting","headline":"Automatic TLS with Let’s Encrypt and HAProxy","dateModified":"2021-02-01T16:45:00-07:00","datePublished":"2021-02-01T16:45:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://hsnodgrass.com/posts/use-letsencrypt-with-haproxy/"},"author":{"@type":"Person","name":"Heston Snodgrass"},"@context":"https://schema.org"}</script><title>Automatic TLS with Let's Encrypt and HAProxy | Heston Snodgrass</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Heston Snodgrass</a></div><div class="site-subtitle font-italic">Coding, SysAd, the DevOps, and some InfoSec</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/hsnodgrass" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/hsnodgrass" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hsnodgrass3','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Automatic TLS with Let's Encrypt and HAProxy</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Automatic TLS with Let's Encrypt and HAProxy</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 1, 2021, 4:45 PM -0700" > Feb 1 <i class="unloaded">2021-02-01T16:45:00-07:00</i> </span> by <span class="author"> Heston Snodgrass </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="638 words">3 min</span></div></div><div class="post-content"><p>I recently moved from the excellent <a href="https://caddyserver.com/v2">Caddy</a> to <a href="http://www.haproxy.org/">HAProxy</a> for my homelab’s reverse-proxy. This change was due to some expanded functionatlity I wanted that Caddy couldn’t provide as part of a larger homelab reorginization. I may get around to writing about that someday, but today I wanted to write about the best feature of Caddy and how I got it working with HAProxy: automatic TLS via <a href="https://letsencrypt.org/">Let’s Encrypt</a>. This walkthrough will get you TLS terminated at HAProxy with a Let’s Encrypt certificate, and we’ll even automate it so the certificate gets automatically renewed.</p><blockquote><p><strong>Note</strong> I have HAProxy running on Ubuntu 20.04, but the steps should be roughly the same regardless of distro used as long as you have <code class="language-plaintext highlighter-rouge">systemd</code>.</p></blockquote><h2 id="pre-reqs">Pre-Reqs</h2><p>To start off, you will need a domain for the Let’s Encrypt certs and you will need to get <a href="https://certbot.eff.org/">certbot</a> running as a <code class="language-plaintext highlighter-rouge">systemd</code> service. You will also need HAProxy installed on your machine. I intend to write about how to set these things up in the future, but it’s out of scope for this article.</p><h2 id="configuration">Configuration</h2><p>Assuming you have HAProxy installed and the HAProxy config is located at <code class="language-plaintext highlighter-rouge">/etc/haproxy/haproxy.cfg</code>, the next thing we need to do is to create a symlink in the HAProxy directory to the live directory for Let’s Encrypt: <code class="language-plaintext highlighter-rouge">ln -s /etc/letsencrypt/live /etc/haproxy/certs.d</code>. This makes it easier to configure HAProxy to read from this directory. If you have HAProxy running as a user besides <code class="language-plaintext highlighter-rouge">root</code>, you will need to <code class="language-plaintext highlighter-rouge">chown</code> the new directory: <code class="language-plaintext highlighter-rouge">chown &lt;user&gt;:&lt;group&gt; /etc/haproxy/certs.d</code>.</p><p>HAProxy frontends require a combined certificate to provide TLS termination. What this means is that the certificate chain and the private key of the TLS certificate are required to exist in one file. Fortunately, creating a combined <code class="language-plaintext highlighter-rouge">.pem</code> is easy: <code class="language-plaintext highlighter-rouge">cat /etc/haproxy/certs.d/&lt;your domain&gt;/fullchain.pem /etc/haproxy/certs.d/&lt;your domain&gt;/privkey.pem &gt; /etc/haproxy/certs.d/&lt;your domain&gt;/&lt;your domain&gt;.pem</code>.</p><p>Now we need to configure HAProxy to use the combined cert for TLS termination. In your HAProxy config, create / modify a <code class="language-plaintext highlighter-rouge">frontend</code> for your domain.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>frontend &lt;your domain&gt;
    bind &lt;IP of HAProxy server&gt;:443 ssl crt /etc/haproxy/certs.d/&lt;your domain&gt;/&lt;your domain&gt;.pem
    mode http
    ...
</pre></table></code></div></div><p>What we’ve done is bind port <code class="language-plaintext highlighter-rouge">443</code> to HAProxy’s IP and provided our combined cert for it to use. Now, any backend you put behind that frontend will present as TLS-encrypted with your Let’s Encrypt certificate. In order for this change to take effect, we must restart HAProxy: <code class="language-plaintext highlighter-rouge">systemctl restart haproxy</code>.</p><p>There is one last step we need to perform. Certbot can provide a <code class="language-plaintext highlighter-rouge">systemd</code> timer service to automatically renew your certs from Let’s Encrypt. If you run <code class="language-plaintext highlighter-rouge">systemctl list-timers | grep certbot</code> you can find the service name. In my case its <code class="language-plaintext highlighter-rouge">snap.certbot.renew.timer</code>. If you see the timer service, you are good to go. Without going too much in-depth, <code class="language-plaintext highlighter-rouge">systemd</code> timers act like <code class="language-plaintext highlighter-rouge">cron</code> jobs but typically start other <code class="language-plaintext highlighter-rouge">systemd</code> services. The certbot service name can be found with <code class="language-plaintext highlighter-rouge">systemctl list-unit-files | grep certbot.*service</code>. Once you have the service name, mine is <code class="language-plaintext highlighter-rouge">snap.certbot.renew.service</code>, we can create the drop-in file.</p><p>Using drop-in files in <code class="language-plaintext highlighter-rouge">systemd</code> is a way to modify the behavior of services without actually editing the unit files. What we want to do now is create a drop-in file for the certbot renew service that automatically creates the combined <code class="language-plaintext highlighter-rouge">.pem</code> file we need. We can do this by running the following command: <code class="language-plaintext highlighter-rouge">systemctl edit &lt;certbot renew service name&gt;</code>. This will bring up a blank file in your text editor. In this file, add the following line:</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ExecStartPost=/bin/cat /etc/letsencrypt/live/home.techmogoyf.dev/fullchain.pem /etc/letsencrypt/live/home.techmogoyf.dev/privkey.pem &gt; /etc/letsencrypt/live/home.techmogoyf.dev/home.techmogoyf.dev.pem; systemctl restart haproxy
</pre></table></code></div></div><p>What will happen now is that every time the renew service runs, it will create our combined <code class="language-plaintext highlighter-rouge">.pem</code> and restart HAProxy for us. We now have automatic TLS for our domain via Let’s Encrypt and HAProxy. These steps can also be repeated so you can have multiple frontends all with different certs, if you so choose.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/haproxy/" class="post-tag no-text-decoration" >haproxy</a> <a href="/tags/letsencrypt/" class="post-tag no-text-decoration" >letsencrypt</a> <a href="/tags/proxy/" class="post-tag no-text-decoration" >proxy</a> <a href="/tags/tls/" class="post-tag no-text-decoration" >tls</a> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Automatic TLS with Let's Encrypt and HAProxy - Heston Snodgrass&url=https://hsnodgrass.com/posts/use-letsencrypt-with-haproxy/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://hsnodgrass.com/posts/use-letsencrypt-with-haproxy/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/haproxy/">haproxy</a> <a class="post-tag" href="/tags/hexidecimal/">hexidecimal</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/ipv4/">ipv4</a> <a class="post-tag" href="/tags/letsencrypt/">letsencrypt</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/proxy/">proxy</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/socket/">socket</a> <a class="post-tag" href="/tags/tls/">tls</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/convert-hex-strings-to-ips-with-ruby/"><div class="card-body"> <span class="timeago small" > Jan 30 <i class="unloaded">2021-01-30T17:00:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Converting Hex Strings to IP Addresses with Ruby</h3><div class="text-muted small"><p> This past week I found myself wanting to parse /proc/net/tcp using pure Ruby. Specifically, I wanted to convert parts of the socket information, specifically the IP and port, to a human-readable fo...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/convert-hex-strings-to-ips-with-ruby/" class="btn btn-outline-primary" prompt="previous"><p>Converting Hex Strings to IP Addresses with Ruby</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://www.linkedin.com/in/hsnodgrass">Heston Snodgrass</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/haproxy/">haproxy</a> <a class="post-tag" href="/tags/hexidecimal/">hexidecimal</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/ipv4/">ipv4</a> <a class="post-tag" href="/tags/letsencrypt/">letsencrypt</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/proxy/">proxy</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/socket/">socket</a> <a class="post-tag" href="/tags/tls/">tls</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://hsnodgrass.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
